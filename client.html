<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Клиент для проекта</title>
<style>
  /* Общие стили */
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f9fafb;
    color: #333;
    margin: 30px auto;
    max-width: 640px;
    padding: 20px;
    box-shadow: 0 0 15px rgba(0,0,0,0.07);
    border-radius: 10px;
  }
  h1 {
    text-align: center;
    color: #007acc;
    margin-bottom: 30px;
  }
  label {
    font-size: 1.1em;
    margin-right: 10px;
  }
  input[type="number"] {
    width: 90px;
    padding: 8px;
    font-size: 1em;
    border: 1.5px solid #ccc;
    border-radius: 6px;
    transition: border-color 0.3s;
  }
  input[type="number"]:focus {
    border-color: #007acc;
    outline: none;
  }
  button {
    background-color: #007acc;
    color: #fff;
    border: none;
    padding: 10px 20px;
    margin-left: 15px;
    font-size: 1em;
    cursor: pointer;
    border-radius: 6px;
    transition: background-color 0.3s;
    user-select: none;
  }
  button:hover:not(:disabled) {
    background-color: #005fa3;
  }
  button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  #status {
    margin-top: 15px;
    font-weight: 600;
    color: #555;
    min-height: 30px;
  }
  #stats {
    margin-top: 30px;
  }
  #stats h2 {
    border-bottom: 2px solid #007acc;
    padding-bottom: 6px;
    margin-bottom: 15px;
    color: #005fa3;
  }
  pre {
    background: #eaeff5;
    padding: 15px;
    border-radius: 8px;
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 1em;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
    max-height: 300px;
    overflow-y: auto;
  }
  /* Документация */
  #docToggle {
    display: block;
    margin: 40px auto 10px;
    font-weight: 600;
    color: #007acc;
    cursor: pointer;
    text-align: center;
    user-select: none;
  }
  #documentation {
    background: #fff;
    border: 1px solid #007acc;
    border-radius: 8px;
    padding: 15px 20px;
    display: none;
    font-size: 0.9em;
    line-height: 1.4;
    max-height: 420px;
    overflow-y: auto;
  }
  #documentation h3 {
    margin-top: 0;
    color: #005fa3;
  }
  /* Вспомогательные кнопки */
  #extraButtons {
    margin-top: 20px;
  }
  #extraButtons button {
    margin-left: 0;
    margin-right: 15px;
  }
  /* Адаптив */
  @media (max-width: 480px) {
    body {
      margin: 15px;
      padding: 15px;
    }
    input[type="number"] {
      width: 70px;
      padding: 6px;
    }
    button {
      padding: 8px 15px;
      font-size: 0.9em;
      margin-left: 10px;
    }
    #extraButtons button {
      margin: 8px 10px 0 0;
      width: 48%;
      display: inline-block;
    }
  }
</style>
</head>
<body>

<h1>Клиент для запуска Beta и просмотра Gamma</h1>

<div>
  <label for="repeatCount">Количество запусков Beta (N): </label>
  <input type="number" id="repeatCount" value="100" min="1" max="1000" />
  <button id="startBtn">Запустить Beta</button>
  <div id="status"></div>
</div>

<div id="extraButtons" style="display:flex; flex-wrap: wrap; margin-top: 10px;">
  <button id="alphaCheckBtn" title="Отправить одиночный заказ (Alpha)">Проверить Alpha</button>
  <button id="gammaRefreshBtn" title="Обновить статистику Gamma вручную">Обновить Gamma</button>
</div>

<div id="stats">
  <h2>Статистика (Gamma):</h2>
  <pre id="gammaOutput">Загрузка...</pre>
</div>

<div id="docToggle">▶ Показать / скрыть документацию проекта</div>
<div id="documentation" role="region" aria-live="polite" aria-label="Документация проекта">
  <h3>Описание проекта</h3>
  <p>Проект реализует API заказов с PostgreSQL и Redis-блокировкой для защиты от повторного запуска. В проекте есть четыре основных компонента:</p>
  <ul>
    <li><b>Alpha.php</b> — Добавляет один заказ в базу, с защитой блокировкой через Redis (используется Upstash и Predis).</li>
    <li><b>Beta.php</b> — Запускает Alpha N раз параллельно, возвращая массив статусов.</li>
    <li><b>Gamma.php</b> — Отдаёт статистику по последним 100 заказам: количество товаров по категориям, общее число заказов, интервал времени между первым и последним.</li>
    <li><b>Клиент</b> (текущая страница) — Интерактивный интерфейс для запуска Beta и просмотра статистики Gamma, а также блок документации.</li>
  </ul>
  <h3>Переменные окружения</h3>
  <ul>
    <li><code>DB_HOST</code>, <code>DB_PORT</code>, <code>DB_NAME</code>, <code>DB_USER</code>, <code>DB_PASS</code>, <code>SSLMODE</code> и <code>SSLROOTCERT</code> — для подключения к PostgreSQL.</li>
    <li><code>REDIS_URL</code> — URL подключения к Upstash Redis с поддержкой TLS (например, <code>rediss://default:token@host:port</code>).</li>
  </ul>
  <h3>Как пользоваться клиентом</h3>
  <ol>
    <li>Введите количество запусков Beta (N), например, 100.</li>
    <li>Нажмите <b>Запустить Beta</b>, чтобы параллельно добавить N заказов.</li>
    <li>Статистика автоматически обновляется каждую секунду.</li>
    <li>Кнопка <b>Проверить Alpha</b> позволяет добавить один заказ вручную отдельно.</li>
    <li>Кнопка <b>Обновить Gamma</b> обновляет статистику немедленно.</li>
  </ol>
  <p>Проект реализован на чистом PHP (без фреймворков), использует PostgreSQL (aiven) и Redis (upstash) для блокировок.</p>
</div>

<script>
  // Элементы
  const startBtn = document.getElementById('startBtn');
  const repeatCountInput = document.getElementById('repeatCount');
  const statusDiv = document.getElementById('status');
  const gammaOutput = document.getElementById('gammaOutput');
  const docToggle = document.getElementById('docToggle');
  const documentation = document.getElementById('documentation');
  const alphaCheckBtn = document.getElementById('alphaCheckBtn');
  const gammaRefreshBtn = document.getElementById('gammaRefreshBtn');

  // Функция загрузки Gamma статистики
  async function fetchGamma() {
    try {
      const response = await fetch('/gamma.php');
      if (!response.ok) throw new Error('Ошибка запроса Gamma');
      const data = await response.json();

      let output = `Всего заказов: ${data.orders_count}\n`;
      output += 'Количество товаров по категориям:\n';

      for (const [cat, count] of Object.entries(data.categories)) {
        output += ` - ${cat}: ${count}\n`;
      }

      output += `Время между первым и последним заказом: ${data.time_between}`;

      gammaOutput.textContent = output;
    } catch (err) {
      gammaOutput.textContent = 'Ошибка получения статистики';
    }
  }

  // Функция запуска Beta с N параллельными запросами
  async function runBeta(n) {
    statusDiv.textContent = 'Запускаем Beta... Пожалуйста, ждите';
    startBtn.disabled = true;
    repeatCountInput.disabled = true;
    alphaCheckBtn.disabled = true;
    gammaRefreshBtn.disabled = true;
    try {
      const response = await fetch(`/beta.php?n=${n}`);
      if (!response.ok) throw new Error('Ошибка запроса Beta');

      const results = await response.json();

    let successCount = results.filter(r => r.http_code === 200 && r.body.includes('Заказ успешно добавлен')).length;
    console.log(results); // для отладки

      statusDiv.textContent = `Beta завершён. Успешных заказов: ${successCount} из ${n}`;
    } catch (err) {
      statusDiv.textContent = `Ошибка запуска Beta: ${err.message}`;
    } finally {
      startBtn.disabled = false;
      repeatCountInput.disabled = false;
      alphaCheckBtn.disabled = false;
      gammaRefreshBtn.disabled = false;
    }
  }

  // Один заказ через Alpha (для проверки)
  async function checkAlpha() {
    statusDiv.textContent = 'Отправляем заказ (Alpha)... Пожалуйста, ждите';
    startBtn.disabled = true;
    repeatCountInput.disabled = true;
    alphaCheckBtn.disabled = true;
    gammaRefreshBtn.disabled = true;

    try {
      const response = await fetch('/alpha.php');
      if (!response.ok) throw new Error('Ошибка запроса Alpha');

      const text = await response.text();

      statusDiv.textContent = `Ответ Alpha: ${text.trim()}`;
    } catch (err) {
      statusDiv.textContent = `Ошибка Alpha: ${err.message}`;
    } finally {
      startBtn.disabled = false;
      repeatCountInput.disabled = false;
      alphaCheckBtn.disabled = false;
      gammaRefreshBtn.disabled = false;
    }
  }

  // Обработчики кнопок
  startBtn.addEventListener('click', () => {
    const n = parseInt(repeatCountInput.value, 10);
    if (isNaN(n) || n < 1 || n > 1000) {
      alert('Введите корректное число от 1 до 1000');
      return;
    }
    runBeta(n);
  });

  alphaCheckBtn.addEventListener('click', () => {
    checkAlpha();
  });

  gammaRefreshBtn.addEventListener('click', () => {
    fetchGamma();
  });

  // Документация - переключатель показа/скрытия
  docToggle.addEventListener('click', () => {
    if (documentation.style.display === 'none' || documentation.style.display === '') {
      documentation.style.display = 'block';
      docToggle.textContent = '▼ Скрыть документацию проекта';
    } else {
      documentation.style.display = 'none';
      docToggle.textContent = '▶ Показать / скрыть документацию проекта';
    }
  });

  // Инициализация
  fetchGamma();
  setInterval(fetchGamma, 1000);
</script>

</body>
</html>
