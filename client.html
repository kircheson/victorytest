<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Клиент для проекта</title>
<style>
  /* Общие стили */
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f9fafb;
    color: #333;
    margin: 30px auto;
    max-width: 640px;
    padding: 20px;
    box-shadow: 0 0 15px rgba(0,0,0,0.07);
    border-radius: 10px;
  }
  h1 {
    text-align: center;
    color: #007acc;
    margin-bottom: 30px;
  }
  label {
    font-size: 1.1em;
    margin-right: 10px;
  }
  input[type="number"] {
    width: 90px;
    padding: 8px;
    font-size: 1em;
    border: 1.5px solid #ccc;
    border-radius: 6px;
    transition: border-color 0.3s;
  }
  input[type="number"]:focus {
    border-color: #007acc;
    outline: none;
  }
  button {
    background-color: #007acc;
    color: #fff;
    border: none;
    padding: 10px 20px;
    margin-left: 15px;
    font-size: 1em;
    cursor: pointer;
    border-radius: 6px;
    transition: background-color 0.3s;
    user-select: none;
  }
  button:hover:not(:disabled) {
    background-color: #005fa3;
  }
  button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
  #status {
    margin-top: 15px;
    font-weight: 600;
    color: #555;
    min-height: 30px;
  }
  #stats {
    margin-top: 30px;
  }
  #stats h2 {
    border-bottom: 2px solid #007acc;
    padding-bottom: 6px;
    margin-bottom: 15px;
    color: #005fa3;
  }
  pre {
    background: #eaeff5;
    padding: 15px;
    border-radius: 8px;
    white-space: pre-wrap;
    word-wrap: break-word;
    font-size: 1em;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
    max-height: 300px;
    overflow-y: auto;
  }
  /* Документация */
  #docToggle {
    display: block;
    margin: 40px auto 10px;
    font-weight: 600;
    color: #007acc;
    cursor: pointer;
    text-align: center;
    user-select: none;
  }
  #documentation {
    background: #fff;
    border: 1px solid #007acc;
    border-radius: 8px;
    padding: 15px 20px;
    display: none;
    font-size: 0.9em;
    line-height: 1.4;
    max-height: 460px;
    overflow-y: auto;
  }
  #documentation h3 {
    margin-top: 0;
    color: #005fa3;
  }
  #documentation ul {
    padding-left: 20px;
  }
  #documentation code {
    background-color: #eee;
    padding: 2px 4px;
    border-radius: 4px;
    font-size: 0.9em;
  }
  /* Вспомогательные кнопки */
  #extraButtons {
    margin-top: 20px;
    display: flex;
    flex-wrap: wrap;
  }
  #extraButtons button {
    margin-left: 0;
    margin-right: 15px;
    margin-bottom: 10px;
  }
  /* Кнопка структуры БД */
  #dbStructureBtn {
    background-color: #0b8043;
  }
  #dbStructureBtn:hover:not(:disabled) {
    background-color: #056622;
  }
  /* Адаптив */
  @media (max-width: 480px) {
    body {
      margin: 15px;
      padding: 15px;
    }
    input[type="number"] {
      width: 70px;
      padding: 6px;
    }
    button {
      padding: 8px 15px;
      font-size: 0.9em;
      margin-left: 10px;
    }
    #extraButtons button {
      margin: 8px 10px 0 0;
      width: 48%;
      display: inline-block;
    }
  }
</style>
</head>
<body>

<h1>Клиент для запуска Beta и просмотра Gamma</h1>

<div>
  <label for="repeatCount">Количество запусков Beta (N): </label>
  <input type="number" id="repeatCount" value="100" min="1" max="1000" />
  <button id="startBtn">Запустить Beta</button>
  <div id="status"></div>
</div>

<div id="extraButtons">
  <button id="alphaCheckBtn" title="Отправить одиночный заказ (Alpha)">Проверить Alpha</button>
  <button id="gammaRefreshBtn" title="Обновить статистику Gamma вручную">Обновить Gamma</button>
  <button id="dbStructureBtn" title="Показать структуру базы данных">Глянуть структуру БД</button>
</div>

<div id="stats">
  <h2>Статистика (Gamma):</h2>
  <pre id="gammaOutput">Загрузка...</pre>
</div>

<div id="docToggle">▶ Показать / скрыть документацию проекта</div>
<div id="documentation" role="region" aria-live="polite" aria-label="Документация проекта">
  <h3>Описание проекта</h3>
  <p>Проект реализует API заказов с использованием PostgreSQL (на Aiven) для хранения данных и Redis (на Upstash) для блокировок от повторного запуска. Основные модули и их функции:</p>
  <ul>
    <li><b>Alpha.php</b><br>
        Добавляет один заказ в базу данных. При этом применяется блокировка через Redis, чтобы предотвратить одновременный запуск нескольких экземпляров. Используется библиотека Predis для взаимодействия с Upstash Redis.</li>
    <li><b>Beta.php</b><br>
        Запускает Alpha скрипт <code>n</code> раз параллельно, с обработкой блокировок и повторными попытками при необходимости. Возвращает массив результатов с HTTP-кодами, ответами и количеством попыток для каждого запуска.</li>
    <li><b>Gamma.php</b><br>
        Возвращает статистику по последним 100 заказам: общее количество заказов, количество товаров по категориям и интервал между первым и последним заказом (в секундах).</li>
    <li><b>Клиент</b> (текущая страница)<br>
        Веб-интерфейс для запуска Beta, вывода статистики Gamma, проверки одиночного Alpha и просмотра документации.</li>
  </ul>

  <h3>Переменные окружения</h3>
  <ul>
    <li><code>DB_HOST</code>, <code>DB_PORT</code>, <code>DB_NAME</code>, <code>DB_USER</code>, <code>DB_PASS</code>, <code>SSLMODE</code>, <code>SSLROOTCERT</code> – параметры подключения к базе PostgreSQL.</li>
    <li><code>REDIS_URL</code> – URL подключения к Upstash Redis с поддержкой TLS, например <code>rediss://default:token@host:port</code>.</li>
  </ul>

  <h3>Как пользоваться клиентом</h3>
  <ol>
    <li>В поле <i>Количество запусков Beta (N)</i> введите число (от 1 до 1000), сколько раз нужно запустить скрипт Alpha.</li>
    <li>Нажмите кнопку <b>Запустить Beta</b>, чтобы запустить N параллельных попыток добавления заказов.</li>
    <li>Статистика заказов автоматически обновляется каждую секунду в блоке "Статистика (Gamma)".</li>
    <li>Кнопка <b>Проверить Alpha</b> позволяет отправить одиночный заказ вручную для теста.</li>
    <li>Кнопка <b>Обновить Gamma</b> позволяет немедленно обновить статистику без ожидания автообновления.</li>
    <li>Кнопка <b>Глянуть структуру БД</b> откроет подробное описание таблиц и их связей.</li>
  </ol>

  <h3>Особенности реализации</h3>
  <ul>
    <li>Redis-блокировка защищает от параллельного выполнения Alpha. При попытке запусков одновременно Alpha выдает ошибку с HTTP-кодом 429 и сообщением "Alpha уже выполняется".</li>
    <li>Beta.php в случае получения блокировок повторяет запросы несколько раз с небольшими задержками, чтобы гарантировать заданное количество успешных запусков Alpha.</li>
    <li>Время жизни блокировки Redis (TTL) в Alpha установлено примерно в 3-5 секунд, чтобы сбалансировать защиту и пропускную способность.</li>
    <li>Все скрипты написаны на чистом PHP без использования фреймворков.</li>
    <li>PostgreSQL используется для хранения данных по заказам, категориям и статистике.</li>
  </ul>
  
  <h3>Примеры запросов и ответов</h3>
  <ul>
    <li><b>Alpha.php</b> — GET запрос, возвращает:<br>
      <code>200 OK</code> с текстом <i>Заказ успешно добавлен!</i><br>
      или <code>429</code> с текстом <i>Alpha уже выполняется, попробуйте позже.</i></li>
    <li><b>Beta.php?n=10</b> — GET запрос, возвращает JSON-массив объектов с полями <code>http_code</code>, <code>body</code>, <code>attempts</code> для каждого из 10 запусков Alpha.</li>
    <li><b>Gamma.php</b> — GET запрос, возвращает JSON с:</li>
      <pre>{
  "orders_count": 100,
  "categories": {
    "Clothing": 50,
    "Electronics": 20,
    ...
  },
  "time_between": 3600
}</pre>
  </ul>

  <p>Документация будет обновляться по мере внесения новых изменений и улучшений проекта.</p>
</div>

<script>
  // Элементы
  const startBtn = document.getElementById('startBtn');
  const repeatCountInput = document.getElementById('repeatCount');
  const statusDiv = document.getElementById('status');
  const gammaOutput = document.getElementById('gammaOutput');
  const docToggle = document.getElementById('docToggle');
  const documentation = document.getElementById('documentation');
  const alphaCheckBtn = document.getElementById('alphaCheckBtn');
  const gammaRefreshBtn = document.getElementById('gammaRefreshBtn');
  const dbStructureBtn = document.getElementById('dbStructureBtn');

  // Функция загрузки Gamma статистики
  async function fetchGamma() {
    try {
      const response = await fetch('/gamma.php');
      if (!response.ok) throw new Error('Ошибка запроса Gamma');
      const data = await response.json();
      console.log("Gamma data:", data); // DEBUG: смотрим приходит ли новый JSON (чтобы видеть наглядное изменение покзаний в окошке с ответом)

    let output = `Всего заказов: ${data.orders_count}\nКоличество товаров по категориям:\n`;

      for (const [cat, count] of Object.entries(data.categories)) {
        output += ` - ${cat}: ${count}\n`;
      }

      output += `Время между первым и последним заказом: ${data.time_between}`;

      gammaOutput.textContent = output;
    } catch (err) {
      gammaOutput.textContent = 'Ошибка получения статистики';
      console.error('Ошибка fetchGamma:', err);
  }
}

// Асинхронный запуск Beta с N попытками запросов к Beta.php (каждый запускает Alpha)
async function runBetaClientSide(n) {
  let completed = 0;
  let success = 0;
  const maxRetries = 15;
  const delayMs = 300;

  statusDiv.textContent = `Запущено ${n} заказов...`;
  startBtn.disabled = true;
  repeatCountInput.disabled = true;
  alphaCheckBtn.disabled = true;
  gammaRefreshBtn.disabled = true;
  dbStructureBtn.disabled = true;

  function sleep(ms) {
    return new Promise(res => setTimeout(res, ms));
  }

  // Возвращаем Promise, который резолвится когда этот запрос полностью выполнен или сброшены повторы
  function sendAlphaWithRetry(retry = 0) {
    return fetch('/beta.php')
      .then(resp => resp.json())
      .then(data => {
        if (data.http_code === 200 && data.body.includes('Заказ успешно добавлен')) {
          success++;
          completed++;
        } else if (
          (data.http_code === 429 || String(data.body).includes('Alpha уже выполняется')) &&
          retry < maxRetries
        ) {
          return sleep(delayMs).then(() => sendAlphaWithRetry(retry + 1));
        } else {
          // Запрос завершён ошибкой, считаем завершённым без успеха
          completed++;
        }
      })
      .catch(() => {
        completed++;
      });
  }

  // Запускаем все промисы и ждём, когда все завершатся
  const promises = [];
  for (let i = 0; i < n; i++) {
    promises.push(sendAlphaWithRetry());
  }

  // Запускаем таймер промежуточного обновления статуса
  const interval = setInterval(() => {
    statusDiv.textContent = `Выполнено: ${completed} из ${n} (успешно: ${success})`;
  }, 1000);

  await Promise.all(promises); // ждём, пока все запросы завершены

  clearInterval(interval);
  statusDiv.textContent = `Готово! Успешно ${success} из ${n}`;

  startBtn.disabled = false;
  repeatCountInput.disabled = false;
  alphaCheckBtn.disabled = false;
  gammaRefreshBtn.disabled = false;
  dbStructureBtn.disabled = false;
}
  }, 1000);
}

// Отдельный запуск Alpha для проверки
async function checkAlpha() {
  statusDiv.textContent = 'Отправляем заказ (Alpha)... Пожалуйста, ждите';
  startBtn.disabled = true;
  repeatCountInput.disabled = true;
  alphaCheckBtn.disabled = true;
  gammaRefreshBtn.disabled = true;
  dbStructureBtn.disabled = true;

  try {
    const response = await fetch('/alpha.php');
    if (!response.ok) throw new Error('Ошибка запроса Alpha');
    const text = await response.text();
    statusDiv.textContent = `Ответ Alpha: ${text.trim()}`;
  } catch (err) {
    statusDiv.textContent = `Ошибка Alpha: ${err.message}`;
  } finally {
    startBtn.disabled = false;
    repeatCountInput.disabled = false;
    alphaCheckBtn.disabled = false;
    gammaRefreshBtn.disabled = false;
    dbStructureBtn.disabled = false;
  }
}

// Обработчики кнопок
startBtn.addEventListener('click', () => {
  const n = parseInt(repeatCountInput.value, 10);
  if (isNaN(n) || n < 1 || n > 1000) {
    alert('Введите корректное число от 1 до 1000');
    return;
  }
  runBetaClientSide(n);
});

alphaCheckBtn.addEventListener('click', () => {
  checkAlpha();
});

gammaRefreshBtn.addEventListener('click', () => {
  fetchGamma();
});

dbStructureBtn.addEventListener('click', () => {
  window.open('db_structure.html', '_blank', 'width=920,height=600,scrollbars=yes');
});

// Переключатель документации
docToggle.addEventListener('click', () => {
  if (documentation.style.display === 'none' || documentation.style.display === '') {
    documentation.style.display = 'block';
    docToggle.textContent = '▼ Скрыть документацию проекта';
  } else {
    documentation.style.display = 'none';
    docToggle.textContent = '▶ Показать / скрыть документацию проекта';
  }
});

// Инициализация
fetchGamma();
setInterval(fetchGamma, 1000);
</script>

</body>
</html>
